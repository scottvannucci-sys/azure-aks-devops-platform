trigger:
  branches:
    include:
      - main
  paths:
    include:
      - app/**

pr:
  branches:
    include:
      - main

variables:
  - group: terraform-dev
  - name: IMAGE_TAG
    value: $(Build.BuildNumber)

stages:
- stage: BuildAndPush
  displayName: Build & Push Image
  jobs:
  - job: Build
    displayName: Docker Build & Push
    steps:
    - checkout: self

    - bash: |
        set -e
        az login --service-principal -u "$ARM_CLIENT_ID" -p "$ARM_CLIENT_SECRET" --tenant "$ARM_TENANT_ID" >/dev/null
        az account set --subscription "$ARM_SUBSCRIPTION_ID"

        ACR_LOGIN_SERVER=$(az acr show -n "$(ACR_NAME)" --query loginServer -o tsv)
        echo "ACR_LOGIN_SERVER=$ACR_LOGIN_SERVER"
        echo "##vso[task.setvariable variable=ACR_LOGIN_SERVER]$ACR_LOGIN_SERVER"
      displayName: "Auth: Azure login + resolve ACR"
      env:
        ARM_CLIENT_ID: $(ARM_CLIENT_ID)
        ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
        ARM_TENANT_ID: $(ARM_TENANT_ID)
        ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)

    - bash: |
        set -e
        echo "Installing tfsec..."
        curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash

        echo "Running tfsec..."
        tfsec terraform/environments/dev || true
      displayName: "Security: tfsec (Terraform)"

    - bash: |
        set -e
        docker build -t "$(ACR_LOGIN_SERVER)/$(IMAGE_NAME):$(IMAGE_TAG)" app/PlatformApi
        docker tag "$(ACR_LOGIN_SERVER)/$(IMAGE_NAME):$(IMAGE_TAG)" "$(ACR_LOGIN_SERVER)/$(IMAGE_NAME):latest"
      displayName: "Build: Docker build"

    - bash: |
        set -e
        docker run --rm \
          -v /var/run/docker.sock:/var/run/docker.sock \
          aquasec/trivy:latest \
          image --severity HIGH,CRITICAL --exit-code 1 "$(ACR_LOGIN_SERVER)/$(IMAGE_NAME):$(IMAGE_TAG)"
      displayName: "Security: Trivy image scan (container)"

    - bash: |
        set -e
        az acr login -n "$(ACR_NAME)"
        docker push "$(ACR_LOGIN_SERVER)/$(IMAGE_NAME):$(IMAGE_TAG)"
        docker push "$(ACR_LOGIN_SERVER)/$(IMAGE_NAME):latest"
      displayName: "Push: Docker push to ACR"


- stage: DeploytoDev
  displayName: Deploy to AKS (Dev)
  dependsOn: BuildAndPush
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  jobs:
  - deployment: DeployToDev
    environment: dev
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: self

          - bash: |
              set -e

              echo "Logging into Azure with service principal..."
              az login --service-principal \
                -u "$ARM_CLIENT_ID" \
                -p "$ARM_CLIENT_SECRET" \
                --tenant "$ARM_TENANT_ID" >/dev/null

              az account set --subscription "$ARM_SUBSCRIPTION_ID"

              ACR_LOGIN_SERVER=$(az acr show -n "$(ACR_NAME)" --query loginServer -o tsv)
              echo "ACR_LOGIN_SERVER=$ACR_LOGIN_SERVER"              

              echo "Getting AKS credentials..."
              az aks get-credentials -g "$(AKS_RG)" -n "$(AKS_NAME)" --overwrite-existing

              echo "Deploying Helm release..."
              helm upgrade --install "$(HELM_RELEASE)" helm/platform-api \
                --namespace "$(HELM_NAMESPACE)" \
                --create-namespace \
                --set image.repository="$ACR_LOGIN_SERVER/$(IMAGE_NAME)" \
                --set image.tag="$(IMAGE_TAG)" \
                --set workloadIdentity.clientId="$(WORKLOAD_IDENTITY_CLIENT_ID)" \
                --set workloadIdentity.tenantId="$(ARM_TENANT_ID)" \
                --set keyVault.name="$(KEY_VAULT_NAME)" \
                --set containerPort=8080 \
                --set service.port=80

              echo "Waiting for rollout..."
              kubectl rollout status deploy/"$(HELM_RELEASE)" -n "$(HELM_NAMESPACE)" --timeout=180s

              echo "Pods:"
              kubectl get pods -n "$(HELM_NAMESPACE)"
            displayName: Helm Deploy
            env:
              ARM_CLIENT_ID: $(ARM_CLIENT_ID)
              ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
              ARM_TENANT_ID: $(ARM_TENANT_ID)
              ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)

- stage: DeploytoProd
  displayName: Deploy to AKS (Prod)
  dependsOn: DeployToDev
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  jobs:
  - deployment: DeployToProd
    environment: prod
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: self

          - bash: |
              set -e
              az login --service-principal \
                -u "$ARM_CLIENT_ID" \
                -p "$ARM_CLIENT_SECRET" \
                --tenant "$ARM_TENANT_ID" >/dev/null

              az account set --subscription "$ARM_SUBSCRIPTION_ID"

              az aks get-credentials -g "$(AKS_RG)" -n "$(AKS_NAME)" --overwrite-existing

              ACR_LOGIN_SERVER=$(az acr show -n "$(ACR_NAME)" --query loginServer -o tsv)

              helm upgrade --install "$(HELM_RELEASE)" helm/platform-api \
              --namespace platform-prod \
              --create-namespace \
              --set ingress.enabled=false \
              --set image.repository="$ACR_LOGIN_SERVER/$(IMAGE_NAME)" \
              --set image.tag="$(IMAGE_TAG)" \
              --set workloadIdentity.clientId="$(WORKLOAD_IDENTITY_CLIENT_ID)" \
              --set workloadIdentity.tenantId="$(ARM_TENANT_ID)" \
              --set keyVault.name="$(KEY_VAULT_NAME)" \
              --set serviceAccount.create=true \
              --set serviceAccount.name=platform-api-sa \
              --set containerPort=8080 \
              --set service.port=80


              kubectl rollout status deploy/"$(HELM_RELEASE)" -n platform-prod --timeout=180s
            env:
              ARM_CLIENT_ID: $(ARM_CLIENT_ID)
              ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
              ARM_TENANT_ID: $(ARM_TENANT_ID)
              ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
